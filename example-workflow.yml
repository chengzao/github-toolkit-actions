# =================================================================
# ğŸš€ GitHub Actions Toolkit ä½¿ç”¨ç¤ºä¾‹
# =================================================================
# æœ¬ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ chengzao/toolkit-actions
# åŒ…å«æœ¬åœ°ä½¿ç”¨å’Œå¤–éƒ¨ä»“åº“å¼•ç”¨çš„å®Œæ•´é…ç½®
# =================================================================

name: CI/CD Pipeline with Toolkit Actions

on:
  push:
    branches: [main, master]
    paths:
      - 'package.json'
      - 'src/**'
      - 'lib/**'
      - 'dist/**'

  pull_request:
    branches: [main, master]

# å¯ç”¨ GitHub Packages å‘å¸ƒæƒé™
permissions:
  contents: read
  packages: write

jobs:
  # ============================================
  # ğŸ“¦ å‘å¸ƒåŒ…åˆ° GitHub Packages
  # ============================================
  publish:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ å‘å¸ƒåŒ…åˆ° GitHub Packages
        uses: chengzao/toolkit-actions/publish-package@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          node-version: '20'
          package-manager: 'yarn'
          build-script: 'build'
          registry: 'npm.pkg.github.com'
          scope: '@your-organization'  # âš ï¸ è¯·æ›¿æ¢ä¸ºä½ çš„ç»„ç»‡ä½œç”¨åŸŸ

  # ============================================
  # ğŸ·ï¸ ç‰ˆæœ¬å˜æ›´æ—¶è‡ªåŠ¨åˆ›å»ºæ ‡ç­¾
  # ============================================
  version-tag:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' &&
      contains(github.event.head_commit.modified, 'package.json')

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ·ï¸ ç‰ˆæœ¬å˜æ›´æ—¶åˆ›å»ºæ ‡ç­¾
        uses: chengzao/toolkit-actions/tag-on-version-change@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          create_changelog: true

  # ============================================
  # ğŸ“… æ¯æ—¥æ„å»ºå¹¶åˆ›å»ºæ ‡ç­¾
  # ============================================
  build-and-tag:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“… æ„å»ºå¹¶åˆ›å»ºæ ‡ç­¾
        uses: chengzao/toolkit-actions/build-tag@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: 'main'
          node-version: '20'
          create_changelog: true

  # ============================================
  # ğŸ” æµ‹è¯•å’ŒéªŒè¯
  # ============================================
  test:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: yarn install

      - name: ğŸ§ª è¿è¡Œæµ‹è¯•
        run: yarn test

      - name: ğŸ”¨ æ„å»ºé¡¹ç›®
        run: yarn build