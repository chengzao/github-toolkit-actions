name: 'Auto Tag and Changelog'
description: 'Automatically creates Git tags on version changes and generates changelog with changelogithub'
author: 'chengzao'

inputs:
  token:
    description: 'GitHub token for creating tags and changelog'
    required: true
  create_changelog:
    description: 'Whether to create changelog using changelogithub'
    required: false
    default: 'true'
  git_user_name:
    description: 'Git user name for commits and tags'
    required: false
    default: 'github-actions'
  git_user_email:
    description: 'Git user email for commits and tags'
    required: false
    default: 'github-actions@github.com'

runs:
  using: 'composite'
  steps:
    - name: Validate Node.js environment
      run: |
        echo ""
        if ! command -v node &> /dev/null; then
          echo "‚ùå Node.js is not installed or not in PATH"
          exit 1
        fi

        if ! command -v npm &> /dev/null; then
          echo "‚ùå npm is not installed or not in PATH"
          exit 1
        fi

        echo "‚úÖ Node.js environment validation passed"
        echo "üì¶ Node.js version: $(node --version)"
        echo "üì¶ npm version: $(npm --version)"
      shell: bash

    - name: Check if version changed
      id: version_check
      run: |
        echo ""
        VERSION=$(node -p "require('./package.json').version")
        echo "Current version: $VERSION"

        if git tag --list "v$VERSION" | grep -q "^v$VERSION$"; then
          echo "‚ö†Ô∏è Tag v$VERSION already exists"
          echo "exists=true" >> "$GITHUB_OUTPUT"
        else
          echo "‚ö†Ô∏è Tag v$VERSION does not exist"
          echo "exists=false" >> "$GITHUB_OUTPUT"
        fi
        echo "version=$VERSION" >> "$GITHUB_OUTPUT"
      shell: bash

    - name: Create Git tag
      if: steps.version_check.outputs.exists == 'false'
      run: |
        echo ""
        git config --global user.name "$GIT_USER_NAME"
        git config --global user.email "$GIT_USER_EMAIL"

        VERSION="$STEP_VERSION"
        TAG_NAME="v$VERSION"

        echo "üè∑Ô∏è Creating tag: $TAG_NAME"
        git tag -a "$TAG_NAME" -m "Release $TAG_NAME"

        echo "üì§ Pushing tag to origin..."
        if git push origin "$TAG_NAME"; then
          echo "‚úÖ Successfully created and pushed tag $TAG_NAME"
        else
          echo "‚ùå Failed to push tag $TAG_NAME"
          exit 1
        fi
      shell: bash
      env:
        GIT_USER_NAME: ${{ inputs.git_user_name }}
        GIT_USER_EMAIL: ${{ inputs.git_user_email }}
        STEP_VERSION: ${{ steps.version_check.outputs.version }}

    - name: Create Changelog
      if: steps.version_check.outputs.exists == 'false' && inputs.create_changelog == 'true'
      run: |
        echo ""
        echo "üìù Creating changelog..."
        if npx changelogithub; then
          echo "‚úÖ Changelog created successfully"
        else
          echo "‚ö†Ô∏è Failed to create changelog, but continuing..."
        fi
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.token }}