name: 'Build and Tag'
description: 'Creates versioned tags with date prefix for releases'
author: 'chengzao'

inputs:
  token:
    description: 'GitHub token for creating tags and changelog'
    required: true
  prefix:
    description: 'Prefix name to use in tag name'
    required: false
    default: 'release'
  git_user_name:
    description: 'Git user name for commits and tags'
    required: false
    default: 'github-actions'
  git_user_email:
    description: 'Git user email for commits and tags'
    required: false
    default: 'github-actions@github.com'

outputs:
  tag_name:
    description: 'The name of the created tag'
    value: ${{ steps.create_tag.outputs.tag_name }}
  tag_created:
    description: 'Whether the tag was created successfully'
    value: ${{ steps.create_tag.outputs.tag_created }}
runs:
  using: 'composite'
  steps:
    - name: Validate Node.js environment
      run: |
        echo ""
        echo "============== ğŸ·ï¸ Validate Node.js environment =============="
        if ! command -v node &> /dev/null; then
          echo "âŒ Node.js is not installed or not in PATH"
          exit 1
        fi

        if ! command -v npm &> /dev/null; then
          echo "âŒ npm is not installed or not in PATH"
          exit 1
        fi

        echo "âœ… Node.js environment validation passed"
        echo "ğŸ“¦ Node.js version: $(node --version)"
        echo "ğŸ“¦ npm version: $(npm --version)"
      shell: bash

    - name: Verify trigger Info
      run: |
        echo ""
        echo "=================== ğŸ·ï¸ Verify trigger Info ==================="
        echo "ğŸ“ äº‹ä»¶ç±»å‹: ${{ github.event_name }}"
        echo "ğŸ  ä»“åº“: ${{ github.repository }}"
        echo "ğŸ‘¤ å·¥ä½œæµå‘èµ·è€…: ${{ github.actor }}"
        echo "ğŸ” äº‹ä»¶å‘é€è€…: ${{ github.event.sender.login }}"
        echo "ğŸŒ¿ å½“å‰åˆ†æ”¯: ${{ github.ref_name }}"
        echo "ğŸ‘¤ æäº¤ä½œè€…: ${{ github.event.head_commit.author.name || 'N/A' }}"
        echo "ğŸ“… æäº¤æ—¶é—´: ${{ github.event.head_commit.timestamp || 'N/A' }}"
        echo "ğŸ”— æäº¤URL: ${{ github.event.head_commit.url || 'N/A' }}"
      shell: bash

    - name: Create a release tag
      id: create_tag
      run: |
        echo ""
        echo "=================== ğŸ·ï¸ Creating release tag ==================="
        git config --global user.name "$GIT_USER_NAME"
        git config --global user.email "$GIT_USER_EMAIL"

        # å½“æ—¥æ—¥æœŸ
        DATE=$(date +"%Y_%m_%d")

        # åˆ†æ”¯åç§°
        CURRENT_BRANCH="$INPUT_PREFIX"

        # è·å–æœ€æ–°ç‰ˆæœ¬å·
        LATEST_TAG=$(git tag -l "${CURRENT_BRANCH}_${DATE}_v*" | sort -V | tail -n1)
        # å¦‚æœä»Šå¤©è¿˜æ²¡æœ‰ç‰ˆæœ¬, ä»v1å¼€å§‹
        if [ -z "$LATEST_TAG" ]; then
            VERSION=1
        else
            # æå–ç°æœ‰çš„æœ€å¤§ç‰ˆæœ¬
            VERSION=${LATEST_TAG#*v}
            # é€’å¢ç‰ˆæœ¬å·
            ((VERSION++))
        fi

        # åˆ›å»ºæ–°çš„æ ‡ç­¾å
        TAG_NAME="${CURRENT_BRANCH}_${DATE}_v${VERSION}"

        echo "ğŸ·ï¸ Creating tag: $TAG_NAME"
        git tag -a "$TAG_NAME" -m "Release $TAG_NAME"

        echo "ğŸ“¤ Pushing tag to origin..."
        # è®¾ç½®é»˜è®¤å€¼
        echo "tag_name=$TAG_NAME" >> "$GITHUB_OUTPUT"
        
        if git push origin $TAG_NAME; then
          echo "âœ… Tag $TAG_NAME pushed successfully"
          echo "tag_created=true" >> "$GITHUB_OUTPUT"
        else
          echo "âŒ Failed to push tag $TAG_NAME"
          echo "tag_created=false" >> "$GITHUB_OUTPUT"
          echo "tag_name=" >> "$GITHUB_OUTPUT"  # æ¸…é™¤æ ‡ç­¾åç§°ï¼Œå› ä¸ºåˆ›å»ºå¤±è´¥
          exit 1
        fi
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.token }}
        INPUT_PREFIX: ${{ inputs.prefix }}
        GIT_USER_NAME: ${{ inputs.git_user_name }}
        GIT_USER_EMAIL: ${{ inputs.git_user_email }}
