name: 'Create Changelog'
description: 'Creates changelog using changelogithub tool'
author: 'chengzao'

inputs:
  token:
    description: 'GitHub token for changelog creation'
    required: true

outputs:
  changelog_created:
    description: 'Whether changelog was created successfully'
    value: ${{ steps.changelog.outputs.changelog_created }}

runs:
  using: 'composite'
  steps:
    - name: Validate Node.js environment
      run: |
        if ! command -v node &> /dev/null; then
          echo "âŒ Node.js is not installed or not in PATH"
          exit 1
        fi

        if ! command -v npm &> /dev/null; then
          echo "âŒ npm is not installed or not in PATH"
          exit 1
        fi

        echo "âœ… Node.js environment validation passed"
        echo "ðŸ“¦ Node.js version: $(node --version)"
        echo "ðŸ“¦ npm version: $(npm --version)"
      shell: bash

    - name: Create Changelog
      id: changelog
      run: |
        # è®¾ç½®ç‰ˆæœ¬å˜é‡
        CHANGELOG_VERSION="latest"
        
        # å®‰è£…changelogithub
        echo "ðŸ“¦ Installing changelogithub version: $CHANGELOG_VERSION"
        if ! npm install -g changelogithub@${CHANGELOG_VERSION}; then
          echo "âŒ Failed to install changelogithub"
          echo "changelog_created=false" >> "$GITHUB_OUTPUT"
          exit 1
        fi

        # è¿è¡Œchangelogç”Ÿæˆ
        echo "ðŸš€ Running changelogeneration..."
        if npx changelogithub; then
          echo "âœ… Changelog created successfully"
          echo "changelog_created=true" >> "$GITHUB_OUTPUT"
        else
          echo "âš ï¸ Failed to create changelog, but continuing..."
          echo "changelog_created=false" >> "$GITHUB_OUTPUT"
        fi
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.token }}